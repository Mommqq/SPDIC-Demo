<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPDIC: Advanced Visualization</title>
    
    <!-- Bootstrap & FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Plotly & MathJax -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Times New Roman', serif; background-color: #f8f9fa; color: #333; }
        .hero-section { background: #fff; padding: 40px 0; border-bottom: 1px solid #ddd; margin-bottom: 30px; }
        .btn-github { background-color: #24292e; color: #fff; border-radius: 30px; padding: 8px 20px; text-decoration: none; font-weight: bold; }
        .btn-github:hover { background-color: #444; color: #fff; }
        .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-radius: 10px; margin-bottom: 20px; }
        .card-header { background: #fff; font-weight: bold; border-bottom: 2px solid #f0f0f0; }
        
        /* Explanation Box */
        #dynamicExplainer { border-left-width: 5px; transition: all 0.3s ease; font-size: 0.95rem; }
        
        /* Math */
        .math-box { background: #eef; padding: 10px; border-left: 4px solid #0d6efd; font-size: 0.9rem; margin-top: 15px; }
        .rho-label { font-style: italic; font-weight: bold; color: #666; }
    </style>
</head>
<body>

<div class="hero-section text-center">
    <div class="container">
        <h2>Perceptual Distributed Image Compression: Only Need Stochasticity</h2>
        <div class="text-muted mb-3">Guojun Xu<sup>1</sup>, et al.</div>
        <a href="https://github.com/Mommqq/SPDIC" target="_blank" class="btn-github"><i class="fab fa-github me-2"></i>Code & Models</a>
    </div>
</div>

<div class="container" style="max-width: 1250px;">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>P-D Trade-off Explorer</span>
            <small class="text-muted fw-normal">Inset plot (top-right) zooms in on the trade-off region</small>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Controls -->
                <div class="col-lg-3 border-end">
                    <h5 class="text-primary mb-3">Controls</h5>
                    
                    <!-- Rho -->
                    <label class="fw-bold d-flex justify-content-between">
                        <span>Correlation &rho;</span>
                        <span id="rhoVal" class="text-primary">0.50</span>
                    </label>
                    <input type="range" class="form-range" id="rhoSlider" min="0.1" max="0.99" step="0.01" value="0.5">
                    <div class="d-flex justify-content-between small text-muted mb-3">
                        <span class="rho-label">&rho;<sub>SI</sub> (0.1)</span>
                        <span>High (0.99)</span>
                    </div>

                    <!-- Beta -->
                    <label class="fw-bold d-flex justify-content-between">
                        <span>Variance &beta;</span>
                        <span id="betaVal" class="text-danger">0.50</span>
                    </label>
                    <input type="range" class="form-range" id="betaSlider" min="0.1" max="1.5" step="0.01" value="0.5">
                    <div class="d-flex justify-content-between small text-muted mb-3">
                        <span>Blur (0.1)</span>
                        <span>Texture (1.0)</span>
                        <span>Noise (1.5)</span>
                    </div>

                    <!-- Status Box -->
                    <div id="dynamicExplainer" class="alert alert-secondary p-2">
                        <span id="statusTitle" class="fw-bold d-block">Status</span>
                        <span id="statusText" class="small">Adjust sliders...</span>
                    </div>

                    <!-- Metrics -->
                    <div class="bg-light p-2 rounded border text-center small mt-3">
                        <div class="row g-0">
                            <div class="col border-end">D (MSE)<br><span id="valD" class="fw-bold fs-6">--</span></div>
                            <div class="col">P (Div)<br><span id="valP" class="fw-bold fs-6">--</span></div>
                        </div>
                    </div>

                    <div class="math-box">
                        $$ D = [(\beta - \rho)^2 + (1 - \rho^2)] \sigma^2 $$
                        $$ P = 0.5 [\ln(\beta^2) + \beta^{-2} - 1] $$
                    </div>
                </div>

                <!-- Main Plot -->
                <div class="col-lg-6">
                    <div id="pdChart" style="height:500px;"></div>
                </div>

                <!-- Distribution Plot -->
                <div class="col-lg-3">
                    <div id="distChart" style="height:250px;"></div>
                    <div class="alert alert-info small mt-2 p-2">
                        <i class="fas fa-search me-1"></i> The <b>Inset Plot</b> (in the middle graph) automatically zooms in on the valid trade-off curve (Solid Blue Line) to show details when &rho; is large.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const sigma2 = 1.0;

    function getD(beta, rho) { return (Math.pow(beta - rho, 2) + (1 - Math.pow(rho, 2))) * sigma2; }
    function getP(beta) {
        let b = Math.max(beta, 0.01);
        return 0.5 * (Math.log(b * b) + 1.0/(b * b) - 1.0);
    }
    function gaussian(x, sigma) {
        return (1.0 / (sigma * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow(x / sigma, 2));
    }

    function updateExplanation(rho, beta) {
        const box = document.getElementById('dynamicExplainer');
        const title = document.getElementById('statusTitle');
        const text = document.getElementById('statusText');
        const eps = 0.03;
        
        let style = "alert-secondary"; let head = ""; let msg = "";

        if (Math.abs(beta - 1.0) <= eps) {
            style = "alert-success"; head = "üåü Perfect Perception";
            msg = "<b>&beta; &approx; 1</b>. Optimal texture. P &rarr; 0.";
            box.style.cssText = "background:#d1e7dd; border-left-color:#198754; color:#0f5132";
        } else if (Math.abs(beta - rho) <= eps) {
            style = "alert-primary"; head = "üìâ Distortion Optimized";
            msg = "<b>&beta; &approx; &rho;</b>. Min MSE, but blurred.";
            box.style.cssText = "background:#cff4fc; border-left-color:#0d6efd; color:#055160";
        } else if (beta < rho) {
            style = "alert-dark"; head = "‚ö†Ô∏è Variance Collapse";
            msg = "<b>&beta; &lt; &rho;</b>. Suboptimal region (Blurry).";
            box.style.cssText = "background:#e2e3e5; border-left-color:#6c757d; color:#41464b";
        } else if (beta > 1.0 + eps) {
            style = "alert-danger"; head = "üö´ Excessive Noise";
            msg = "<b>&beta; &gt; 1</b>. Suboptimal region (Noisy).";
            box.style.cssText = "background:#f8d7da; border-left-color:#dc3545; color:#842029";
        } else {
            style = "alert-warning"; head = "‚öñÔ∏è Valid Trade-off";
            msg = "<b>&rho; &lt; &beta; &lt; 1</b>. Optimization path.";
            box.style.cssText = "background:#fff3cd; border-left-color:#ffc107; color:#664d03";
        }
        
        box.className = `alert p-2 ${style}`;
        title.innerHTML = head; text.innerHTML = msg;
    }

    function updateCharts() {
        let rho = parseFloat(document.getElementById('rhoSlider').value);
        let beta = parseFloat(document.getElementById('betaSlider').value);

        document.getElementById('rhoVal').innerText = rho.toFixed(2);
        document.getElementById('betaVal').innerText = beta.toFixed(2);
        let currD = getD(beta, rho); let currP = getP(beta);
        document.getElementById('valD').innerText = currD.toFixed(3);
        document.getElementById('valP').innerText = currP.toFixed(3);
        updateExplanation(rho, beta);

        // --- Data Gen ---
        let genData = (start, end, step) => {
            let x=[], y=[];
            for(let b=start; b<=end; b+=step) { x.push(getD(b, rho)); y.push(getP(b)); }
            return {x, y};
        };

        // 1. Blurry (beta < rho)
        let blurData = genData(0.1, rho, 0.01);
        // 2. Trade-off (rho <= beta <= 1)
        let tradeData = genData(rho, 1.0, 0.005);
        // 3. Noisy (beta > 1)
        let noiseData = genData(1.0, 1.5, 0.01);

        // Key Points
        let minD = {x:[getD(rho, rho)], y:[getP(rho)]};
        let ideal = {x:[getD(1.0, rho)], y:[getP(1.0)]};
        let curr = {x:[currD], y:[currP]};

        // --- Traces for Main Plot ---
        let tBlur = {x:blurData.x, y:blurData.y, mode:'lines', name:'Blurry', line:{color:'#bbb', width:2, dash:'dot'}};
        let tTrade = {x:tradeData.x, y:tradeData.y, mode:'lines', name:'Trade-off', line:{color:'#0d6efd', width:4}};
        let tNoise = {x:noiseData.x, y:noiseData.y, mode:'lines', name:'Noisy', line:{color:'#999', width:2, dash:'dot'}};
        
        // Traces for Inset (Zoomed) - Same data, different axis binding
        let tTradeZoom = {
            x: tradeData.x, y: tradeData.y, mode: 'lines', 
            line: {color: '#0d6efd', width: 3}, xaxis: 'x2', yaxis: 'y2', showlegend: false
        };
        let tCurrZoom = {
            x: curr.x, y: curr.y, mode: 'markers', 
            marker: {color: '#d62728', size: 10, line:{color:'white', width:1}}, 
            xaxis: 'x2', yaxis: 'y2', showlegend: false
        };

        let tPts = {
            x:[minD.x[0], ideal.x[0]], y:[minD.y[0], ideal.y[0]], mode:'markers',
            marker:{color:['black', '#198754'], size:10, symbol:['diamond', 'star']}, name:'Key Points'
        };
        let tCurr = {
            x:curr.x, y:curr.y, mode:'markers', name:'Current',
            marker:{color:'#d62728', size:14, line:{color:'white', width:2}}
        };

        // --- Layout with Inset ---
        // Calculate inset ranges dynamically based on trade-off segment
        let xMinZoom = Math.min(...tradeData.x);
        let xMaxZoom = Math.max(...tradeData.x);
        let yMinZoom = Math.min(...tradeData.y);
        let yMaxZoom = Math.max(...tradeData.y);
        
        // Add padding to zoom view
        let xPad = (xMaxZoom - xMinZoom) * 0.1 || 0.01;
        let yPad = (yMaxZoom - yMinZoom) * 0.1 || 0.01;

        let layoutPD = {
            title: '<b>P-D Trade-off Curve</b>',
            // Main Axis: Fixed range to show global context
            xaxis: {title: 'Distortion D', range: [0, 1.2], domain: [0, 1]},
            yaxis: {title: 'Perception P', range: [-0.1, 1.5], domain: [0, 1]}, // Capped at 1.5 to show Noisy line curve up
            
            // Inset Axis (Zoom) -> Top Right
            xaxis2: {
                domain: [0.55, 0.95], anchor: 'y2', 
                range: [xMinZoom - xPad, xMaxZoom + xPad],
                title: 'Zoom (Trade-off)', titlefont: {size: 10}, tickfont: {size: 9}
            },
            yaxis2: {
                domain: [0.55, 0.95], anchor: 'x2', 
                range: [yMinZoom - yPad, yMaxZoom + yPad],
                tickfont: {size: 9}
            },
            
            showlegend: false,
            margin: {l:50, r:20, t:40, b:40},
            shapes: [
                // Optional: Box around inset area to distinguish it
                { type: 'rect', xref: 'paper', yref: 'paper', x0: 0.55, y0: 0.55, x1: 0.95, y1: 0.95, line: {color: '#ccc'} }
            ]
        };

        // --- Distribution Plot ---
        let xR = []; for(let i=-4; i<=4; i+=0.1) xR.push(i);
        let dO = xR.map(x=>gaussian(x, 1.0));
        let dR = xR.map(x=>gaussian(x, beta));
        let traceDO = {x:xR, y:dO, fill:'tozeroy', line:{width:0, color:'#0d6efd'}};
        let traceDR = {x:xR, y:dR, mode:'lines', line:{width:3, color:'#d62728'}};
        let layoutDist = {
            title: '<b>Distribution</b>', margin: {l:30, r:10, t:30, b:30},
            xaxis: {title: '', showticklabels: false}, yaxis: {range: [0, 1.0]}, showlegend: false
        };

        Plotly.react('pdChart', [tBlur, tTrade, tNoise, tTradeZoom, tCurrZoom, tPts, tCurr], layoutPD);
        Plotly.react('distChart', [traceDO, traceDR], layoutDist);
    }

    document.getElementById('rhoSlider').addEventListener('input', updateCharts);
    document.getElementById('betaSlider').addEventListener('input', updateCharts);
    updateCharts();
</script>

</body>
</html>
